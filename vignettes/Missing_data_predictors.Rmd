---
title: "Training a Tabnet model from missing-values dataset"
author: "Christophe Regouby"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{pretrain from dataset with missing-values}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Motivation

Real-life training dataset usually contains missing data. The vast majority of deep-learning networks do not handle missing data and thus either stop or crash when values are missing in the predictors.

But Tabnet use a masking mechanism that can be adapted to cover the missing data in the training set.

# Missing-data dataset creation

## Ames

The `ames` dataset from the `modeldata` packages contains a lot of numerical value 0 that the human analysis clearly translate into missing data, like pool size of 0 square meters, basement surface of 0 square meters, ...A lot of them can be detected visually by inspecting the distribution of the values like for the `Masonry veneer area` predictor :
```{r}
suppressPackageStartupMessages(library(tidymodels))
library(tabnet)
data("ames", package = "modeldata")
qplot(ames$Mas_Vnr_Area)
```

## Ames with missing data

Let's dig up those missing data :

A quick and dirty way to achieve it is to `na_if()` zeros on surface and area columns. 

```{r}
col_with_zero_as_na <- ames %>% select_if(is.numeric) %>% select(matches("_SF|Area")) %>% summarise_each(min) %>% select_if(~.x==0) %>% names()
ames_missing <- ames %>% mutate_at(col_with_zero_as_na, na_if, 0) %>% 
  mutate_at("Alley", na_if, "No_Alley_Access") %>% 
  mutate_at("Pool_QC", na_if, "No_Pool") %>% 
  mutate_at(c("Garage_Cond", "Garage_Finish", "Garage_Type"), na_if, "No_Garage") %>% 
  mutate_at(c("Bsmt_Cond", "Bsmt_Exposure", "BsmtFin_Type_1", "BsmtFin_Type_2"), na_if, "No_Basement")
visdat::vis_miss(ames_missing)
```

A better way to achieve it would be to turn numerical value to NA when the corresponding description columns refer to `none` or to zero occurence of the equipment. But this is beyond the scope of this vignette.

## Variable importance with `ames` dataset

```{r}
ames_fit <- tabnet_pretrain(Sale_Price ~ ., data=ames, epoch=40, valid_split = 0.2, verbose=TRUE, batch=2930)
autoplot(ames_fit)

```


## Variable importance with `ames_missing` dataset

```{r}
ames_missing_fit <- tabnet_pretrain(Sale_Price ~ ., data=ames_missing, epoch=40, valid_split = 0.2, verbose=TRUE, batch=2930)
autoplot(ames_missing_fit)

```

